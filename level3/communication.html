<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Level 3 - Communication Practice</title>
    <link rel="stylesheet" href="../css/output.css">
</head>

<body class="tb-shell tb-chat">

    <div class="tb-container py-4">
        <div class="mx-auto max-w-4xl">
            <header class="tb-header">
                <div class="relative overflow-hidden rounded-3xl border border-white/40 bg-gradient-to-r from-slate-900 via-indigo-900 to-violet-900 px-6 py-8 text-white shadow-xl sm:px-10">
                    <div class="absolute -right-16 -top-16 h-56 w-56 rounded-full bg-white/10 blur-2xl"></div>
                    <div class="absolute -bottom-24 -left-24 h-72 w-72 rounded-full bg-fuchsia-400/20 blur-3xl"></div>
                    <div class="relative flex items-start justify-between gap-4">
                        <div>
                            <div class="tb-badge">Level 3 · AI coach</div>
                            <h1 class="mt-4 text-3xl font-extrabold tracking-tight sm:text-5xl">Communication practice</h1>
                            <p class="mt-3 max-w-2xl text-white/85">Chat with the AI and get corrections to improve your English.</p>
                        </div>
                        <button class="tb-btn-secondary" onclick="window.location.href='../level2/level2_dashboard.html'">← Level 2</button>
                    </div>
                </div>
            </header>

            <div class="tb-card flex h-[67vh]  md:h-[65vh] flex-col overflow-hidden p-0">
                <div class="flex items-center justify-between gap-3 border-b border-slate-200 bg-white px-5 py-4">
                    <div class="text-sm font-semibold text-slate-900">AI Communication Coach</div>
                    <div id="coinDisplay" class="tb-badge">Coins: 0</div>
                </div>

                <div id="chatBox" class="flex-1 overflow-y-auto px-5 py-4"></div>

                <div class="flex items-center gap-3 border-t border-slate-200 bg-white px-5 py-4">
                    <input class="tb-input py-4" type="text" id="userInput" placeholder="Type your message..." />
                    <button class="tb-btn shrink-0" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

<script>
let coins = parseInt(localStorage.getItem("coins") || "0");
document.getElementById("coinDisplay").innerText = "Coins: " + coins;

async function sendMessage() {

    const input = document.getElementById("userInput");
    const message = input.value.trim();

    if (!message) return;

    addMessage(message, "user");

    input.value = "";

    try {
        const response = await fetch("https://teachbuddy.onrender.com/chat", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ message })
        });

        const data = await response.json();

        processAIResponse(data.reply);

        // reward coins
        coins += 5;
        localStorage.setItem("coins", coins);
        document.getElementById("coinDisplay").innerText = "Coins: " + coins;

    } catch (error) {
        addMessage("Server error. Please check backend.", "ai");
        console.error(error);
    }
}

function processAIResponse(fullText) {

    // Split reply and correction
    let reply = fullText;
    let correction = "";

    if (fullText.includes("Correction:")) {
        const parts = fullText.split("Correction:");
        reply = parts[0].trim();
        correction = parts[1].trim();
    }

    addMessage(reply, "ai");

    if (correction) {
        addMessage("Correction: " + correction, "correction");
    }
}

function addMessage(text, type) {

    const chatBox = document.getElementById("chatBox");

    const div = document.createElement("div");
    div.classList.add("message", type);
    div.innerText = text;

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Enter key support
document.getElementById("userInput")
.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
        sendMessage();
    }
});
</script>

</body>
</html>